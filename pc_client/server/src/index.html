<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>index</title>
</head>
<body>
	<div>
		<p>
			<a href="javascript:void(0)" id="add" onclick="newbook()">添加</a>
			<input type="date" id="time"></p>
		</p>
		<div>
			<p>已录入</p>
			<p id="booknames"></p>
		</div>
		<p>
			<label for="">bookname:</label><span id='activiteBook'></span>
		</p>
			<label for="">word:</label>
			<input type="text" id="word"></p>
		<p>
			<label for="">counter:</label>
			<span id="count"></span>
		</p>
		<p>
			<a href="javascript:void(0)" onclick="save()" id="record">录入</a>
		</p>
	</div>
	<div>
		<p>
			<a href="javascript:void(0)" onclick="savetoserver()">保存到服务器</a>
		</p>
	</div>
	<div id="items">
		
	</div>
	<script>
		var wordlist={};
		var activelist;

		function newbook(){
			var name=new Date(document.getElementById("time").value).getTime();
			if(!wordlist[name]){
				wordlist[name]=[];
			}
			activelist=wordlist[name];
			document.getElementById("count").innerHTML=activelist.length;
			document.getElementById("activiteBook").innerHTML=name;
			showBookNames();
			showBook();
		}
		function showBookNames(){
			var html=[];
			for(var o in wordlist){
				html.push("<a href='javascript:void(0)' style='margin:2em'>"+new Date(Number(o)).toLocaleDateString()+"</a>");
			}
			document.getElementById("booknames").innerHTML=html.join("");	
		}
		function save () {
			var item={
				word:document.getElementById('word').value,
				name:document.getElementById("activiteBook").innerHTML				
			};
			activelist.push(item);
			document.getElementById('word').value="";
			document.getElementById("count").innerHTML=activelist.length;
			getMeaning(item);
		}
		function savetoserver(){
			var xhr=new XMLHttpRequest();
			xhr.open("post","common/savewordlist");
			var data="";
			data+="list="+JSON.stringify(activelist);
			data+="&name="+document.getElementById("activiteBook").innerHTML;

			xhr.onreadystatechange = function() {			
				if (xhr.readyState == 4) {
					xhr.onreadystatechange=null;
					if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
						alert("success");
					} else {
						alert("error");
					}
				}
			};
			xhr.send(data);
		}
		function getMeaning(item,cb) {
			var xhr=new XMLHttpRequest();
			xhr.open("post","http://fy.iciba.com/api.php");
			var data=new FormData();
			data.append("type","auto");
			data.append("q",item.word);
			xhr.onreadystatechange = function() {			
				if (xhr.readyState == 4) {
					xhr.onreadystatechange=null;
					if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
						var responseData=JSON.parse(xhr.responseText);
						var reg=/(<p>[\s]*?<span\s*class=\"dt\">.+<\/p>)/;
						item.meaning=responseData.ret.replace(/\r\n/g,"");
						if(reg.test(item.meaning)){
							item.meaning=RegExp.$1;
						}
						showBook();
					} else {
						alert("get meaning error");
					}
				}
			};
			xhr.send(data);
		}
		function showBook(){
			var html=[];

			for(var i=0;i<activelist.length;i++){
				html.push("<p onclick='showMeaning()'>"+activelist[i].word+"</p>");
				html.push("<div style='display:none'>"+activelist[i].meaning+"</div>");
			}
			document.getElementById("items").innerHTML=html.join("");
		}
		function showMeaning(){
			var next=this.nextElementSibling;
			if(next.style.display==="none"){
				next.style.display="block";
			}else{
				next.style.display="none";
			}
		}
		document.getElementById("word").onkeypress=function(e){
			if(e.keyCode=="13"){

				save();
			}
		}
		document.getElementById("record").onkeypress=function(e){
			if(e.key.toLowerCase()=="enter"){
				save();
				document.getElementById("word").focus();
			}
		}
	</script></body>
</html>